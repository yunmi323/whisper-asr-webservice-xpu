name: Build and Release Docker Image
 
on:
  push:
    tags:
      - '*'
 
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
 
    - name: Build Docker Image
      uses: docker/build-push-action@v2
      with:
        push: false
        tags: user/app:latest
 
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          Changes in this release:
          - ...
    - name: Upload Docker Image to Release
      uses: easingthemes/docker-archive-action@v2.1.1
      with:
        image: user/app:latest
        archive: docker
        include_manifest: true
        github_token: ${{ secrets.GITHUB_TOKEN }}
        release_id: ${{ steps.create_release.outputs.id }}
